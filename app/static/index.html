<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Download Service - Debug Panel</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        [v-cloak] { display: none; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" v-cloak>
        <!-- Header -->
        <header class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-900">Video Download Service</h1>
                <div class="flex items-center space-x-4">
                    <span :class="healthStatus.healthy ? 'text-green-600' : 'text-red-600'" class="flex items-center">
                        <span class="w-2 h-2 rounded-full mr-2" :class="healthStatus.healthy ? 'bg-green-500' : 'bg-red-500'"></span>
                        {{ healthStatus.healthy ? 'API Online' : 'API Offline' }}
                    </span>
                    <span class="text-gray-500 text-sm">v{{ healthStatus.version || '1.0.0' }}</span>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 py-6">
            <!-- Stats Cards -->
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-sm text-gray-500">Total Tasks</div>
                    <div class="text-2xl font-bold">{{ stats.total }}</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-sm text-gray-500">Downloading</div>
                    <div class="text-2xl font-bold text-blue-600">{{ stats.downloading }}</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-sm text-gray-500">Completed</div>
                    <div class="text-2xl font-bold text-green-600">{{ stats.completed }}</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-sm text-gray-500">Failed</div>
                    <div class="text-2xl font-bold text-red-600">{{ stats.failed }}</div>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-6">
                <!-- Left: Task Submit Form -->
                <div class="col-span-1">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-lg font-semibold mb-4">Submit Download Task</h2>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Video URL *</label>
                                <input
                                    v-model="form.url"
                                    type="text"
                                    placeholder="https://www.bilibili.com/video/..."
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Callback URL (Optional)</label>
                                <input
                                    v-model="form.callback_url"
                                    type="text"
                                    placeholder="https://your-server.com/callback"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Custom Filename (Optional)</label>
                                <input
                                    v-model="form.filename"
                                    type="text"
                                    placeholder="my-video"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                            </div>

                            <div class="flex space-x-2">
                                <button
                                    @click="getVideoInfo"
                                    :disabled="!form.url || loading.info"
                                    class="flex-1 px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {{ loading.info ? 'Loading...' : 'Preview Info' }}
                                </button>
                                <button
                                    @click="submitTask"
                                    :disabled="!form.url || loading.submit"
                                    class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {{ loading.submit ? 'Submitting...' : 'Download' }}
                                </button>
                            </div>
                        </div>

                        <!-- Video Info Preview -->
                        <div v-if="videoInfo" class="mt-6 p-4 bg-gray-50 rounded-lg">
                            <h3 class="font-medium mb-2">Video Info</h3>
                            <img v-if="videoInfo.thumbnail" :src="videoInfo.thumbnail" class="w-full h-32 object-cover rounded mb-2">
                            <p class="font-medium text-sm">{{ videoInfo.title }}</p>
                            <div class="text-xs text-gray-500 mt-1 space-y-1">
                                <p v-if="videoInfo.duration">Duration: {{ formatDuration(videoInfo.duration) }}</p>
                                <p v-if="videoInfo.uploader">Uploader: {{ videoInfo.uploader }}</p>
                                <p v-if="videoInfo.view_count">Views: {{ videoInfo.view_count.toLocaleString() }}</p>
                            </div>
                        </div>

                        <!-- Error Message -->
                        <div v-if="error" class="mt-4 p-3 bg-red-50 border border-red-200 rounded-md">
                            <p class="text-red-600 text-sm">{{ error }}</p>
                        </div>

                        <!-- Success Message -->
                        <div v-if="success" class="mt-4 p-3 bg-green-50 border border-green-200 rounded-md">
                            <p class="text-green-600 text-sm">{{ success }}</p>
                        </div>
                    </div>
                </div>

                <!-- Right: Task List -->
                <div class="col-span-2">
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b flex justify-between items-center">
                            <h2 class="text-lg font-semibold">Task List</h2>
                            <div class="flex items-center space-x-2">
                                <label class="flex items-center text-sm text-gray-600">
                                    <input type="checkbox" v-model="autoRefresh" class="mr-1">
                                    Auto Refresh
                                </label>
                                <button @click="refreshTasks" class="text-blue-600 hover:text-blue-800 text-sm">
                                    Refresh
                                </button>
                            </div>
                        </div>

                        <div class="divide-y">
                            <div v-if="tasks.length === 0" class="px-6 py-8 text-center text-gray-500">
                                No tasks yet. Submit a video URL to start downloading.
                            </div>

                            <div v-for="task in tasks" :key="task.id" class="px-6 py-4 hover:bg-gray-50">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center space-x-2">
                                            <span
                                                class="px-2 py-0.5 text-xs font-medium rounded-full"
                                                :class="getStatusClass(task.status)"
                                            >
                                                {{ task.status }}
                                            </span>
                                            <span class="text-xs text-gray-400">{{ task.id ? task.id.slice(0, 8) + '...' : '' }}</span>
                                        </div>
                                        <p class="mt-1 font-medium text-gray-900 truncate" :title="(task.video_info && task.video_info.title) || task.video_url">
                                            {{ (task.video_info && task.video_info.title) || task.video_url }}
                                        </p>
                                        <p class="text-xs text-gray-500 truncate">{{ task.video_url }}</p>

                                        <!-- Progress Bar -->
                                        <div v-if="task.status === 'downloading'" class="mt-2">
                                            <div class="flex justify-between text-xs text-gray-500 mb-1">
                                                <span>
                                                    <template v-if="task.video_info && task.video_info.filesize">
                                                        {{ formatFileSize(task.video_info.filesize * task.progress / 100) }} / {{ formatFileSize(task.video_info.filesize) }}
                                                    </template>
                                                    <template v-else>Downloading...</template>
                                                </span>
                                                <span class="font-medium">{{ task.progress.toFixed(1) }}%</span>
                                            </div>
                                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                                <div
                                                    class="bg-blue-600 h-2.5 rounded-full transition-all duration-300"
                                                    :style="{width: Math.max(task.progress, 1) + '%'}"
                                                ></div>
                                            </div>
                                        </div>

                                        <!-- Pending status -->
                                        <div v-if="task.status === 'pending'" class="mt-2 text-xs text-gray-500">
                                            <span>Waiting in queue...</span>
                                        </div>

                                        <!-- File Info (Completed) -->
                                        <div v-if="task.status === 'completed'" class="mt-2 text-xs text-green-600">
                                            <p v-if="task.result && task.result.file_name">File: {{ task.result.file_name }}</p>
                                            <p v-if="task.result && task.result.file_size">Size: {{ formatFileSize(task.result.file_size) }}</p>
                                        </div>

                                        <!-- Error Message -->
                                        <div v-if="task.status === 'failed' && task.error" class="mt-2">
                                            <p class="text-xs text-red-600">{{ task.error.message || 'Download failed' }}</p>
                                        </div>

                                        <p class="text-xs text-gray-400 mt-1">
                                            Created: {{ formatTime(task.created_at) }}
                                        </p>
                                    </div>

                                    <div class="ml-4 flex space-x-2">
                                        <button
                                            @click="viewTask(task.id)"
                                            class="text-gray-400 hover:text-blue-600"
                                            title="View Details"
                                        >
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                            </svg>
                                        </button>
                                        <button
                                            @click="deleteTask(task.id)"
                                            class="text-gray-400 hover:text-red-600"
                                            title="Delete Task"
                                        >
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Task Detail Modal -->
        <div v-if="selectedTask" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="selectedTask = null">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-auto">
                <div class="px-6 py-4 border-b flex justify-between items-center">
                    <h3 class="text-lg font-semibold">Task Details</h3>
                    <button @click="selectedTask = null" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="p-6">
                    <pre class="bg-gray-100 p-4 rounded-lg overflow-auto text-sm">{{ JSON.stringify(selectedTask, null, 2) }}</pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted } = Vue;

        createApp({
            setup() {
                const API_BASE = '/api/v1';

                // State
                const form = ref({
                    url: '',
                    callback_url: '',
                    filename: ''
                });
                const tasks = ref([]);
                const videoInfo = ref(null);
                const selectedTask = ref(null);
                const healthStatus = ref({ healthy: false, version: '' });
                const loading = ref({ info: false, submit: false });
                const error = ref('');
                const success = ref('');
                const autoRefresh = ref(true);
                let refreshInterval = null;

                // Computed
                const stats = computed(() => {
                    const total = tasks.value.length;
                    const downloading = tasks.value.filter(t => t.status === 'downloading' || t.status === 'pending').length;
                    const completed = tasks.value.filter(t => t.status === 'completed').length;
                    const failed = tasks.value.filter(t => t.status === 'failed').length;
                    return { total, downloading, completed, failed };
                });

                // Methods
                const checkHealth = async () => {
                    try {
                        const res = await fetch(`${API_BASE}/health`);
                        const data = await res.json();
                        healthStatus.value = { healthy: true, version: data.version };
                    } catch (e) {
                        healthStatus.value = { healthy: false, version: '' };
                    }
                };

                const refreshTasks = async () => {
                    try {
                        // Get all task IDs we're tracking
                        for (const task of tasks.value) {
                            if (!task.id) continue;
                            const res = await fetch(`${API_BASE}/tasks/${task.id}`);
                            if (res.ok) {
                                const updated = await res.json();
                                updated.id = updated.task_id; // Normalize field name
                                const index = tasks.value.findIndex(t => t.id === task.id);
                                if (index !== -1) {
                                    tasks.value[index] = updated;
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Failed to refresh tasks:', e);
                    }
                };

                const getVideoInfo = async () => {
                    if (!form.value.url) return;

                    loading.value.info = true;
                    error.value = '';
                    videoInfo.value = null;

                    try {
                        const res = await fetch(`${API_BASE}/video-info`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ video_url: form.value.url })
                        });

                        if (!res.ok) {
                            const data = await res.json();
                            throw new Error(data.detail || 'Failed to get video info');
                        }

                        videoInfo.value = await res.json();
                    } catch (e) {
                        error.value = e.message;
                    } finally {
                        loading.value.info = false;
                    }
                };

                const submitTask = async () => {
                    if (!form.value.url) return;

                    loading.value.submit = true;
                    error.value = '';
                    success.value = '';

                    try {
                        const payload = { video_url: form.value.url };
                        if (form.value.callback_url) payload.callback_url = form.value.callback_url;
                        if (form.value.filename) payload.options = { filename: form.value.filename };

                        const res = await fetch(`${API_BASE}/tasks`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!res.ok) {
                            const data = await res.json();
                            throw new Error(data.detail || 'Failed to submit task');
                        }

                        const task = await res.json();
                        // Normalize field names (backend uses task_id, frontend uses id)
                        task.id = task.task_id;
                        tasks.value.unshift(task);
                        success.value = `Task submitted! ID: ${task.id.slice(0, 8)}...`;

                        // Clear form
                        form.value.url = '';
                        form.value.callback_url = '';
                        form.value.filename = '';
                        videoInfo.value = null;

                        // Clear success message after 3s
                        setTimeout(() => { success.value = ''; }, 3000);
                    } catch (e) {
                        error.value = e.message;
                    } finally {
                        loading.value.submit = false;
                    }
                };

                const viewTask = async (taskId) => {
                    try {
                        const res = await fetch(`${API_BASE}/tasks/${taskId}`);
                        if (res.ok) {
                            selectedTask.value = await res.json();
                        }
                    } catch (e) {
                        console.error('Failed to fetch task:', e);
                    }
                };

                const deleteTask = async (taskId) => {
                    if (!confirm('Are you sure you want to delete this task?')) return;

                    try {
                        const res = await fetch(`${API_BASE}/tasks/${taskId}`, { method: 'DELETE' });
                        if (res.ok) {
                            tasks.value = tasks.value.filter(t => t.id !== taskId);
                        }
                    } catch (e) {
                        console.error('Failed to delete task:', e);
                    }
                };

                const getStatusClass = (status) => {
                    const classes = {
                        pending: 'bg-yellow-100 text-yellow-800',
                        downloading: 'bg-blue-100 text-blue-800',
                        completed: 'bg-green-100 text-green-800',
                        failed: 'bg-red-100 text-red-800'
                    };
                    return classes[status] || 'bg-gray-100 text-gray-800';
                };

                const formatDuration = (seconds) => {
                    const h = Math.floor(seconds / 3600);
                    const m = Math.floor((seconds % 3600) / 60);
                    const s = Math.floor(seconds % 60);
                    if (h > 0) return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                    return `${m}:${s.toString().padStart(2, '0')}`;
                };

                const formatFileSize = (bytes) => {
                    if (!bytes) return '';
                    const units = ['B', 'KB', 'MB', 'GB'];
                    let i = 0;
                    while (bytes >= 1024 && i < units.length - 1) {
                        bytes /= 1024;
                        i++;
                    }
                    return `${bytes.toFixed(2)} ${units[i]}`;
                };

                const formatTime = (isoString) => {
                    if (!isoString) return '';
                    return new Date(isoString).toLocaleString();
                };

                // Lifecycle
                onMounted(() => {
                    checkHealth();

                    // Set up auto refresh
                    refreshInterval = setInterval(() => {
                        checkHealth();
                        if (autoRefresh.value && tasks.value.length > 0) {
                            refreshTasks();
                        }
                    }, 3000);
                });

                onUnmounted(() => {
                    if (refreshInterval) clearInterval(refreshInterval);
                });

                return {
                    form,
                    tasks,
                    videoInfo,
                    selectedTask,
                    healthStatus,
                    loading,
                    error,
                    success,
                    autoRefresh,
                    stats,
                    checkHealth,
                    refreshTasks,
                    getVideoInfo,
                    submitTask,
                    viewTask,
                    deleteTask,
                    getStatusClass,
                    formatDuration,
                    formatFileSize,
                    formatTime
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
